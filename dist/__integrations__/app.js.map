{"version":3,"sources":["../../server/__integrations__/app.js"],"names":["it","setup","variables","host","rootDir","templates","hero","method","route","response","body","name","photos","status","app","get","expect","res","text","toMatchSnapshot","error","detail","validate","headers","set","done","timeout","delay","simulate","deadline","catch","err","message","toEqual","post","send","query","power"],"mappings":";;AAEA;;;;AAEA;;;;;;AAEAA,GAAG,yBAAH,oBAA8B,aAAY;AACxC,QAAMC,QAAQ;AACZC,eAAW;AACTC,YAAM,uBADG;AAETC,eAAS;AAFA,KADC;AAKZC,eAAW,CACT;AACEH,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,KAJV;AAKEC,aAAO,qBALT;AAMEC,gBAAU;AACRC,cAAM;AACJC,gBAAM,aADF;AAEJC,kBAAQ;AAFJ,SADE;AAKRC,gBAAQ;AALA;AANZ,KADS;AALC,GAAd;;AAuBA,QAAMC,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,SAAO,yBAAUa,GAAV,EACJC,GADI,CACA,gBADA,EAEJC,MAFI,CAEG,UAACC,GAAD,EAAS;AACfD,WAAOC,IAAIC,IAAX,EAAiBC,eAAjB;AACD,GAJI,EAKJH,MALI,CAKG,GALH,CAAP;AAMD,CAhCD;;AAkCAhB,GAAG,sBAAH,oBAA2B,aAAY;AACrC,QAAMC,QAAQ;AACZC,eAAW;AACTC,YAAM,uBADG;AAETC,eAAS;AAFA,KADC;AAKZC,eAAW,CACT;AACEH,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,KAJV;AAKEC,aAAO,qBALT;AAMEC,gBAAU;AACRC,cAAM;AACJC,gBAAM,aADF;AAEJC,kBAAQ;AAFJ,SADE;AAKRQ,eAAO;AACLC,kBAAQ;AADH,SALC;AAQRR,gBAAQ;AARA,OANZ;AAgBES,gBAAU;AACRC,iBAAS;AACP,0BAAgB;AADT;AADD;AAhBZ,KADS;AALC,GAAd;;AA+BA,QAAMT,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,SAAO,yBAAUa,GAAV,EACJC,GADI,CACA,gBADA,EAEJS,GAFI,CAEA,cAFA,EAEgB,iBAFhB,EAGJR,MAHI,CAGG,UAACC,GAAD,EAAS;AACfD,WAAOC,IAAIC,IAAX,EAAiBC,eAAjB;AACD,GALI,EAMJH,MANI,CAMG,GANH,CAAP;AAOD,CAzCD;;AA2CAhB,GAAG,iCAAH,oBAAsC,aAAY;AAChD,QAAMC,QAAQ;AACZC,eAAW;AACTC,YAAM,uBADG;AAETC,eAAS;AAFA,KADC;AAKZC,eAAW,CACT;AACEH,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,KAJV;AAKEC,aAAO,qBALT;AAMEC,gBAAU;AACRC,cAAM,oDADE;AAERG,gBAAQ;AAFA;AANZ,KADS;AALC,GAAd;;AAoBA,QAAMC,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,SAAO,yBAAUa,GAAV,EACJC,GADI,CACA,gBADA,EAEJC,MAFI,CAEG,UAACC,GAAD,EAAS;AACfD,WAAOC,IAAIC,IAAX,EAAiBC,eAAjB;AACD,GAJI,EAKJH,MALI,CAKG,GALH,CAAP;AAMD,CA7BD;;AA+BAhB,GAAG,kBAAH;AAAA,gCAAuB,WAAOyB,IAAP,EAAgB;AACrC,UAAMC,UAAU,GAAhB;AACA,UAAMC,QAAQ,EAAd;;AAEA,UAAM1B,QAAQ;AACZC,iBAAW;AACTC,cAAM,uBADG;AAETC,iBAAS;AAFA,OADC;AAKZC,iBAAW,CACT;AACEH,mBAAW;AACTI,gBAAM;AADG,SADb;AAIEC,gBAAQ,KAJV;AAKEC,eAAO,qBALT;AAMEC,kBAAU;AACRC,gBAAM,EADE;AAERU,iBAAO,EAFC;AAGRP,kBAAQ;AAHA,SANZ;AAWEe,kBAAU;AACRF,mBAASA,UAAUC;AADX;AAXZ,OADS;AALC,KAAd;;AAwBA,UAAMb,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,WAAO,yBAAUa,GAAV,EACJC,GADI,CACA,gBADA,EAEJW,OAFI,CAEI,EAAEjB,UAAUiB,OAAZ,EAAqBG,UAAUH,OAA/B,EAFJ,EAGJI,KAHI,CAGE,UAACC,GAAD,EAAS;AACdf,aAAOe,IAAIC,OAAX,EAAoBC,OAApB,CAA6B,cAAaP,OAAQ,aAAlD;AACAD;AACD,KANI,CAAP;AAOD,GArCD;;AAAA;AAAA;AAAA;AAAA;;AAuCAzB,GAAG,wBAAH,oBAA6B,aAAY;AACvC,QAAMC,QAAQ;AACZC,eAAW;AACTC,YAAM,uBADG;AAETC,eAAS;AAFA,KADC;AAKZC,eAAW,CACT;AACEH,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,MAJV;AAKEC,aAAO,qBALT;AAMEC,gBAAU;AACRC,cAAM;AACJC,gBAAM,aADF;AAEJC,kBAAQ;AAFJ,SADE;AAKRQ,eAAO;AACLC,kBAAQ;AADH,SALC;AAQRR,gBAAQ;AARA,OANZ;AAgBES,gBAAU;AACRZ,cAAM;AACJC,gBAAM;AADF;AADE;AAhBZ,KADS;AALC,GAAd;;AA+BA,QAAMG,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,SAAO,yBAAUa,GAAV,EACJoB,IADI,CACC,gBADD,EAEJC,IAFI,CAEC,qBAFD,EAGJX,GAHI,CAGA,QAHA,EAGU,kBAHV,EAKJR,MALI,CAKG,UAACC,GAAD,EAAS;AACfD,WAAOC,IAAIC,IAAX,EAAiBC,eAAjB;AACD,GAPI,EAQJH,MARI,CAQG,GARH,CAAP;AASD,CA3CD;;AA6CAhB,GAAG,+BAAH,oBAAoC,aAAY;AAC9C,QAAMC,QAAQ;AACZC,eAAW;AACTC,YAAM,uBADG;AAETC,eAAS;AAFA,KADC;AAKZC,eAAW,CACT;AACEH,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,KAJV;AAKEC,aAAO,qBALT;AAME4B,aAAO;AACLC,eAAO;AADF,OANT;AASE5B,gBAAU;AACRC,cAAM;AACJC,gBAAM,aADF;AAEJ0B,iBAAO;AAFH,SADE;AAKRxB,gBAAQ;AALA;AATZ,KADS,EAkBT;AACEX,iBAAW;AACTI,cAAM;AADG,OADb;AAIEC,cAAQ,KAJV;AAKEC,aAAO,qBALT;AAMEC,gBAAU;AACRC,cAAM;AACJC,gBAAM,aADF;AAEJC,kBAAQ;AAFJ,SADE;AAKRC,gBAAQ;AALA;AANZ,KAlBS;AALC,GAAd;;AAwCA,QAAMC,MAAM,MAAM,oBAAUb,KAAV,CAAlB;;AAEA,SAAO,yBAAUa,GAAV,EACJC,GADI,CACA,2BADA,EAEJC,MAFI,CAEG,UAACC,GAAD,EAAS;AACfD,WAAOC,IAAIC,IAAX,EAAiBC,eAAjB;AACD,GAJI,EAKJH,MALI,CAKG,GALH,CAAP;AAMD,CAjDD","file":"app.js","sourcesContent":["/* @flow */\n\nimport supertest from 'supertest';\n\nimport { createApp } from '../app';\n\nit('returns simple response', async () => {\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: '../../',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: {\n            name: '<%= hero %>',\n            photos: '<%= host %>/<%= hero %>/photos',\n          },\n          status: 200,\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .get('/heroes/spider')\n    .expect((res) => {\n      expect(res.text).toMatchSnapshot();\n    })\n    .expect(200);\n});\n\nit('validates the header', async () => {\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: '../../',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: {\n            name: '<%= hero %>',\n            photos: '<%= host %>/<%= hero %>/photos',\n          },\n          error: {\n            detail: '<%= hero %> is not feeling well',\n          },\n          status: 400,\n        },\n        validate: {\n          headers: {\n            'content-type': 'application/json',\n          },\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .get('/heroes/spider')\n    .set('content-type', 'application/bla')\n    .expect((res) => {\n      expect(res.text).toMatchSnapshot();\n    })\n    .expect(400);\n});\n\nit('loads an external response body', async () => {\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: './',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: '<%= rootDir %>server/__integrations__/fixture.json',\n          status: 200,\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .get('/heroes/spider')\n    .expect((res) => {\n      expect(res.text).toMatchSnapshot();\n    })\n    .expect(200);\n});\n\nit('simulate timeout', async (done) => {\n  const timeout = 100;\n  const delay = 10;\n\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: './',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: {},\n          error: {},\n          status: 200,\n        },\n        simulate: {\n          timeout: timeout + delay,\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .get('/heroes/spider')\n    .timeout({ response: timeout, deadline: timeout })\n    .catch((err) => {\n      expect(err.message).toEqual(`Timeout of ${timeout}ms exceeded`);\n      done();\n    });\n});\n\nit('validates body payload', async () => {\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: '../../',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'post',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: {\n            name: '<%= hero %>',\n            photos: '<%= host %>/<%= hero %>/photos',\n          },\n          error: {\n            detail: '<%= hero %> is not feeling well',\n          },\n          status: 400,\n        },\n        validate: {\n          body: {\n            name: 'required',\n          },\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .post('/heroes/spider')\n    .send('bla=name is missing')\n    .set('Accept', 'application/json')\n\n    .expect((res) => {\n      expect(res.text).toMatchSnapshot();\n    })\n    .expect(400);\n});\n\nit('filter router by query string', async () => {\n  const setup = {\n    variables: {\n      host: 'http://localhost:3000',\n      rootDir: '../../',\n    },\n    templates: [\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        query: {\n          power: 'true',\n        },\n        response: {\n          body: {\n            name: '<%= hero %>',\n            power: 'spider sense',\n          },\n          status: 200,\n        },\n      },\n      {\n        variables: {\n          hero: 'spider',\n        },\n        method: 'get',\n        route: '/heroes/<%= hero %>',\n        response: {\n          body: {\n            name: '<%= hero %>',\n            photos: '<%= host %>/<%= hero %>/photos',\n          },\n          status: 200,\n        },\n      },\n    ],\n  };\n\n  const app = await createApp(setup);\n\n  return supertest(app)\n    .get('/heroes/spider?power=true')\n    .expect((res) => {\n      expect(res.text).toMatchSnapshot();\n    })\n    .expect(200);\n});\n"]}